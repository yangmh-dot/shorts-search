<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Shorts AI â€“ ç†±é–€çŸ­ç‰‡å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue: #2563eb;
      --blue-dark: #1d4ed8;
      --bg: #0f172a;
      --card-bg: #0b1220;
      --border: #1e293b;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: var(--text-main);
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.5rem;
      text-align: left;
      margin: 0 0 8px;
    }
    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 14px;
    }

    .shell-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      padding: 10px 8px;
      border: 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .tab-btn span.emoji { font-size: 1.1rem; }
    .tab-btn.active {
      background: linear-gradient(135deg, #4f46e5, #ec4899);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.6);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.82rem;
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    input, select, textarea, button {
      font-family: inherit;
      font-size: 0.9rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 9px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      margin-bottom: 8px;
    }
    input::placeholder, textarea::placeholder { color: #6b7280; }
    textarea {
      min-height: 70px;
      resize: vertical;
    }

    button.primary {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      color: white;
      font-weight: 700;
      margin-top: 4px;
    }
    button.primary:active {
      transform: translateY(1px);
      opacity: 0.9;
    }
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: transparent;
      color: var(--text-muted);
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .two-cols {
      display: flex;
      gap: 8px;
    }
    .two-cols > div { flex: 1; }
    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    #status {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .video-list { margin-top: 10px; }
    .video-item {
      display: flex;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #111827;
    }
    .video-item:last-child { border-bottom: none; }
    .thumb {
      flex-shrink: 0;
      width: 90px;
      height: 50px;
      border-radius: 8px;
      overflow: hidden;
      background: #020617;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .video-main {
      flex: 1;
      min-width: 0;
    }
    .video-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .video-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .video-link a {
      font-size: 0.78rem;
      color: #60a5fa;
      text-decoration: none;
      word-break: break-all;
    }
    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      background: rgba(37, 99, 235, 0.15);
      color: #bfdbfe;
      margin-left: 4px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .checkbox-row input {
      width: auto;
      margin-bottom: 0;
    }

    @media (min-width: 720px) {
      .two-cols-desktop {
        display: flex;
        gap: 12px;
      }
      .two-cols-desktop > .card { flex: 1; }
    }
  </style>
</head>
<body>
  <main>
    <h1>Shorts AI å·¥å…·æ¿</h1>
    <div class="subtitle">
      ä¸€å€‹é é¢å®Œæˆï¼šéˆæ„Ÿç”Ÿæˆ + ç†±é–€ Shorts æŒ–æ˜ã€‚ç›´æ¥æŠ“æœ€è¿‘é«˜è§€çœ‹çŸ­ç‰‡ï¼Œæ–¹ä¾¿ä½ åƒè€ƒæ¨™é¡Œèˆ‡å…§å®¹ä¾†å¯« promptã€‚
    </div>

    <div class="shell-card">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn" data-tab="idea">
          <span class="emoji">âœ¨</span> éˆæ„Ÿç”Ÿæˆ
        </button>
        <button class="tab-btn active" data-tab="hot">
          <span class="emoji">ğŸ”¥</span> æŒ–æ˜ç†±é–€
        </button>
      </div>

      <!-- Tab: éˆæ„Ÿç”Ÿæˆï¼ˆç‰ˆå‹ï¼‰ -->
      <section id="tab-idea" class="tab-panel">
        <div class="two-cols-desktop">
          <div class="card">
            <div class="chips-row" style="margin-bottom:4px;">
              <span class="badge">é¡åˆ¥</span>
              <span class="badge">æ¨¡å¼ 2ï¼šçµæ§‹åŒ–</span>
            </div>
            <div class="two-cols">
              <div>
                <label>ä¸»é¡Œ</label>
                <input id="ideaTopic" type="text" placeholder="ä¾‹å¦‚ï¼šè²“ç‹—è·å ´å–œåŠ‡ Shorts" />
              </div>
              <div>
                <label>æ°›åœ</label>
                <input id="ideaMood" type="text" placeholder="ä¾‹å¦‚ï¼šæç¬‘ã€ç·Šå¼µã€ç™‚ç™’" />
              </div>
            </div>
            <label>ç´°ç¯€</label>
            <textarea id="ideaDetail" placeholder="å¯å¡«å…¥è§’è‰²ã€å ´æ™¯ã€åè½‰ã€é…æ¨‚æ„Ÿè¦ºâ€¦"></textarea>

            <button id="runIdea" class="primary" type="button">
              âš¡ å•Ÿå‹•éˆæ„Ÿç”Ÿæˆï¼ˆä¿ç•™çµ¦ä½ ä¹‹å¾Œæ¥ Gemini/ChatGPTï¼‰
            </button>
            <div id="ideaHint" style="font-size:0.78rem; color:var(--text-muted); margin-top:6px;">
              ç›®å‰é€™å€‹æŒ‰éˆ•åªæ˜¯ç‰ˆå‹ç¤ºæ„ï¼Œä½ å¯ä»¥åœ¨ script è£¡æ”¹æˆå‘¼å«è‡ªå·±çš„å¾Œç«¯ / Gemini / OpenAI APIã€‚
            </div>
          </div>

          <div class="card">
            <div class="chips-row">
              <span class="badge">æ–°å¢ä¼åŠƒ</span>
              <button class="btn-ghost" type="button" onclick="resetIdeaOutputs()">Reset</button>
            </div>
            <label>ä¸­æ–‡æ¨™é¡Œ</label>
            <textarea id="titleZh" placeholder="é€™è£¡é ç•™çµ¦æ¨¡å‹ç”¢ç”Ÿçš„ä¸­æ–‡æ¨™é¡Œ"></textarea>
            <label>è‹±æ–‡æ¨™é¡Œ</label>
            <textarea id="titleEn" placeholder="é€™è£¡é ç•™çµ¦æ¨¡å‹ç”¢ç”Ÿçš„è‹±æ–‡æ¨™é¡Œ"></textarea>
            <label>ä¸­æ–‡èªªæ˜</label>
            <textarea id="descZh" placeholder="ä¸­æ–‡èªªæ˜ / å…§å®¹å¤§ç¶±"></textarea>
            <label>è‹±æ–‡èªªæ˜</label>
            <textarea id="descEn" placeholder="è‹±æ–‡èªªæ˜ / å…§å®¹å¤§ç¶±"></textarea>
          </div>
        </div>
      </section>

      <!-- Tab: æŒ–æ˜ç†±é–€ Shorts -->
      <section id="tab-hot" class="tab-panel active">
        <div class="card">
          <div class="chips-row">
            <span class="badge">ğŸ”‘ YouTube API Key</span>
          </div>
          <label for="apiKey">YouTube API Keyï¼ˆåªåœ¨ç€è¦½å™¨æœ¬æ©Ÿä½¿ç”¨ï¼‰</label>
          <input id="apiKey" type="password" placeholder="è«‹è²¼ä¸Šä½ çš„ API Key" />
        </div>

        <div class="card">
          <div class="chips-row">
            <span class="badge">ğŸ”¥ æŒ–æ˜ç†±é–€ Shorts</span>
            <span class="badge">Beta</span>
          </div>

          <div class="two-cols">
            <div>
              <label for="region">åœ°å€ï¼ˆRegionï¼‰</label>
              <select id="region">
                <option value="">ä¸é™ï¼ˆGlobalï¼‰</option>
                <option value="US">USï¼ˆç¾åœ‹ï¼‰</option>
                <option value="TW">TWï¼ˆå°ç£ï¼‰</option>
                <option value="JP">JPï¼ˆæ—¥æœ¬ï¼‰</option>
                <option value="KR">KRï¼ˆéŸ“åœ‹ï¼‰</option>
                <option value="GB">GBï¼ˆè‹±åœ‹ï¼‰</option>
                <option value="DE">DEï¼ˆå¾·åœ‹ï¼‰</option>
                <option value="FR">FRï¼ˆæ³•åœ‹ï¼‰</option>
                <option value="BR">BRï¼ˆå·´è¥¿ï¼‰</option>
                <option value="IN">INï¼ˆå°åº¦ï¼‰</option>
                <option value="ID">IDï¼ˆå°å°¼ï¼‰</option>
                <option value="TH">THï¼ˆæ³°åœ‹ï¼‰</option>
                <option value="VN">VNï¼ˆè¶Šå—ï¼‰</option>
                <option value="MX">MXï¼ˆå¢¨è¥¿å“¥ï¼‰</option>
              </select>
            </div>
            <div>
              <label for="category">é¡åˆ¥ï¼ˆCategoryï¼‰</label>
              <select id="category">
                <option value="">ä¸é™é¡åˆ¥ï¼ˆå…¨éƒ¨ï¼‰</option>
                <option value="15">Pets &amp; Animalsï¼ˆå¯µç‰©èˆ‡å‹•ç‰©ï¼‰</option>
                <option value="24">Entertainmentï¼ˆå¨›æ¨‚ï¼‰</option>
                <option value="23">Comedyï¼ˆå–œåŠ‡ï¼‰</option>
                <option value="20">Gamingï¼ˆéŠæˆ²ï¼‰</option>
                <option value="10">Musicï¼ˆéŸ³æ¨‚ï¼‰</option>
                <option value="17">Sportsï¼ˆé‹å‹•ï¼‰</option>
                <option value="22">People &amp; Blogs</option>
                <option value="26">Howto &amp; Style</option>
                <option value="27">Education</option>
                <option value="28">Science &amp; Technology</option>
                <option value="1">Film &amp; Animation</option>
              </select>
            </div>
          </div>

          <div class="two-cols">
            <div>
              <label for="days">æ™‚é–“ï¼ˆæœ€è¿‘å¹¾å¤©å…§ä¸Šæ¶ï¼‰</label>
              <input id="days" type="number" min="1" value="10" />
            </div>
            <div>
              <label for="maxSeconds">ç‰‡é•·ä¸Šé™ï¼ˆç§’ï¼Œå»ºè­° 60 ä»¥å…§ï¼‰</label>
              <input id="maxSeconds" type="number" min="1" value="60" />
            </div>
          </div>

          <div class="two-cols">
            <div>
              <label for="keyword">é—œéµå­—ï¼ˆå¯ç•™ç©ºï¼‰</label>
              <input id="keyword" type="text" placeholder="ä¾‹å¦‚ï¼šcat dogã€AIã€minecraft shortsâ€¦" />
            </div>
            <div>
              <label for="minViews">æœ€å°‘è§€çœ‹æ•¸ï¼ˆå¯ç•™ç©ºï¼‰</label>
              <input id="minViews" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š1000000" />
            </div>
          </div>

          <label for="channel">é »é“ï¼ˆå¯é¸å¡«ï¼šID / @handle / é »é“ç¶²å€ï¼‰</label>
          <input id="channel" type="text" placeholder="ä¾‹å¦‚ï¼šUCxxxx...ã€@MrBeast æˆ– https://www.youtube.com/@xxx" />

          <div class="two-cols">
            <div>
              <label for="limit">è¦æŠ“å–å‰å¹¾åï¼ˆä¾è§€çœ‹æ•¸æ’åºï¼‰</label>
              <input id="limit" type="number" min="1" max="100" value="20" />
            </div>
            <div>
              <label for="pages">API æœå°‹é æ•¸ä¸Šé™ï¼ˆæ¯é  50 ç­†ï¼‰</label>
              <input id="pages" type="number" min="1" max="5" value="3" />
            </div>
          </div>

          <div class="checkbox-row">
            <input id="onlyCreators" type="checkbox" />
            <label for="onlyCreators" style="margin-bottom:0;">
              åªæ•´ç† Shorts å‰µä½œè€…æ¸…å–®ï¼ˆä¾é »é“å½™ç¸½ï¼Œä¸é¡¯ç¤ºæ¯æ”¯å½±ç‰‡ï¼‰
            </label>
          </div>

          <button id="searchHotBtn" class="primary" type="button">
            ğŸ” æœå°‹ç†±é–€ Shorts
          </button>
          <div id="status"></div>
        </div>

        <div class="card">
          <div class="chips-row" id="resultModeBadges">
            <span class="badge">çµæœåˆ—è¡¨ï¼šå½±ç‰‡</span>
          </div>
          <div id="results" class="video-list"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabPanels = document.querySelectorAll(".tab-panel");

    const apiKeyInput = document.getElementById("apiKey");
    const regionSelect = document.getElementById("region");
    const categorySelect = document.getElementById("category");
    const daysInput = document.getElementById("days");
    const maxSecondsInput = document.getElementById("maxSeconds");
    const keywordInput = document.getElementById("keyword");
    const minViewsInput = document.getElementById("minViews");
    const channelInput = document.getElementById("channel");
    const limitInput = document.getElementById("limit");
    const pagesInput = document.getElementById("pages");
    const onlyCreatorsCheckbox = document.getElementById("onlyCreators");
    const searchHotBtn = document.getElementById("searchHotBtn");
    const statusDiv = document.getElementById("status");
    const resultsDiv = document.getElementById("results");
    const resultModeBadges = document.getElementById("resultModeBadges");

    const YT_SEARCH_BASE = "https://www.googleapis.com/youtube/v3/search";
    const YT_VIDEOS_BASE = "https://www.googleapis.com/youtube/v3/videos";
    const YT_CHANNELS_BASE = "https://www.googleapis.com/youtube/v3/channels";

    // Tab åˆ‡æ›
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");
        tabButtons.forEach(b => b.classList.remove("active"));
        tabPanels.forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("tab-" + target).classList.add("active");
      });
    });

    // API Key æœ¬æ©Ÿä¿å­˜
    (function loadApiKey() {
      const saved = localStorage.getItem("yt_api_key");
      if (saved) apiKeyInput.value = saved;
    })();
    apiKeyInput.addEventListener("change", () => {
      localStorage.setItem("yt_api_key", apiKeyInput.value.trim());
    });

    // éˆæ„Ÿ Reset
    function resetIdeaOutputs() {
      document.getElementById("titleZh").value = "";
      document.getElementById("titleEn").value = "";
      document.getElementById("descZh").value = "";
      document.getElementById("descEn").value = "";
    }
    window.resetIdeaOutputs = resetIdeaOutputs;

    // æœå°‹ç†±é–€ Shorts
    searchHotBtn.addEventListener("click", async () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        alert("è«‹å…ˆå¡«å…¥ YouTube API Key");
        return;
      }

      const days = parseInt(daysInput.value, 10) || 0;
      if (days <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å¤©æ•¸ï¼ˆè‡³å°‘ 1 å¤©ï¼‰");
        return;
      }

      const maxSeconds = parseInt(maxSecondsInput.value, 10) || 0;
      if (maxSeconds <= 0) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‰‡é•·ä¸Šé™ï¼ˆç§’ï¼‰");
        return;
      }

      const limit = parseInt(limitInput.value, 10) || 20;
      const maxPages = Math.max(1, Math.min(5, parseInt(pagesInput.value, 10) || 3));
      const regionCode = regionSelect.value;
      const categoryId = categorySelect.value || null;
      const keyword = keywordInput.value.trim();
      const minViews = parseInt(minViewsInput.value, 10) || 0;
      const onlyCreators = onlyCreatorsCheckbox.checked;
      const channelRaw = channelInput.value.trim();

      statusDiv.textContent = "æŸ¥è©¢ä¸­â€¦ï¼ˆå¯èƒ½éœ€è¦æ•¸ç§’ï¼Œè¦– API å›æ‡‰è€Œå®šï¼‰";
      resultsDiv.innerHTML = "";

      try {
        let channelId = null;
        if (channelRaw) {
          channelId = await resolveChannelId(apiKey, channelRaw);
          if (!channelId) {
            alert("æ‰¾ä¸åˆ°å°æ‡‰çš„é »é“ IDï¼Œæœƒæ”¹æˆå¿½ç•¥é »é“æ¢ä»¶ç¹¼çºŒæœå°‹ã€‚");
          }
        }

        const videos = await searchPopularShorts({
          apiKey,
          regionCode,
          categoryId,
          days,
          maxSeconds,
          keyword,
          minViews,
          limit,
          maxPages,
          channelId
        });

        if (!videos.length) {
          statusDiv.textContent = "æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡ï¼Œå»ºè­°ï¼šæ‹‰é•·å¤©æ•¸ã€é™ä½æœ€å°‘è§€çœ‹æ•¸ã€æ”¾å¯¬ç‰‡é•·ã€‚";
          resultModeBadges.innerHTML = '<span class="badge">çµæœåˆ—è¡¨</span>';
          return;
        }

        if (onlyCreators) {
          const creatorIds = new Set(videos.map(v => v.channelId).filter(Boolean));
          const creatorCount = creatorIds.size;
          statusDiv.textContent = `å…±æ•´ç†å‡º ${creatorCount} å€‹é »é“ï¼Œä¾†è‡ª ${videos.length} éƒ¨ Shortsï¼ˆä¾é »é“ç¸½è§€çœ‹æ•¸æ’åºï¼‰ã€‚`;
          resultModeBadges.innerHTML = '<span class="badge">çµæœåˆ—è¡¨ï¼šå‰µä½œè€…</span>';
          renderCreators(videos);
        } else {
          statusDiv.textContent = `å…±å–å¾— ${videos.length} éƒ¨å½±ç‰‡ï¼ˆä¾è§€çœ‹æ•¸ç”±é«˜åˆ°ä½ï¼‰ã€‚`;
          resultModeBadges.innerHTML = '<span class="badge">çµæœåˆ—è¡¨ï¼šå½±ç‰‡</span>';
          renderResults(videos);
        }
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼š" + (err.message || String(err));
        resultModeBadges.innerHTML = '<span class="badge">çµæœåˆ—è¡¨</span>';
      }
    });

    // è§£æé »é“è¼¸å…¥ â†’ channelId
    async function resolveChannelId(apiKey, raw) {
      let s = raw.trim();
      if (!s) return null;

      if (s.startsWith("UC") && s.length >= 10 && !s.includes(" ")) {
        return s;
      }

      const idMatch = s.match(/youtube\.com\/channel\/([^/?]+)/i);
      if (idMatch) {
        return idMatch[1];
      }

      let handle = null;
      const handleUrlMatch = s.match(/youtube\.com\/(@[^/?]+)/i);
      if (handleUrlMatch) {
        handle = handleUrlMatch[1].replace("@", "");
      } else if (s.startsWith("@")) {
        handle = s.slice(1);
      }

      if (!handle) return null;

      const params = new URLSearchParams({
        key: apiKey,
        part: "id",
        forHandle: handle
      });
      const url = `${YT_CHANNELS_BASE}?${params.toString()}`;
      const res = await fetch(url);
      const json = await res.json();

      if (!res.ok) {
        console.warn("resolveChannelId error", json);
        return null;
      }
      const items = json.items || [];
      if (!items.length) return null;
      return items[0].id;
    }

    // æ ¹æ“šæ¢ä»¶é¸æ“‡æœå°‹ç­–ç•¥
    async function searchPopularShorts(options) {
      const { keyword, channelId } = options;
      const useMostPopular = !keyword && !channelId; // ç„¡é—œéµå­— & ç„¡é »é“ â†’ ç†±é–€æ’è¡Œæ¦œæ¨¡å¼

      if (useMostPopular) {
        return searchByMostPopular(options);
      } else {
        return searchBySearchAPI(options);
      }
    }

    // æ¨¡å¼ Aï¼šç„¡é—œéµå­— / ç„¡é »é“ â†’ ä½¿ç”¨ videos.list?chart=mostPopular
    async function searchByMostPopular(options) {
      const {
        apiKey,
        regionCode,
        categoryId,
        days,
        maxSeconds,
        minViews,
        limit,
        maxPages
      } = options;

      const now = new Date();
      const afterDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      const publishedAfter = afterDate.toISOString();

      const videos = [];
      let pageToken = null;
      let pageCount = 0;

      while (pageCount < maxPages && videos.length < limit * 3) {
        const params = new URLSearchParams({
          key: apiKey,
          part: "snippet,statistics,contentDetails",
          chart: "mostPopular",
          maxResults: "50"
        });

        // mostPopular å»ºè­°ä¸€å®šè¦æœ‰ regionCodeï¼Œæ²’æœ‰å°±ç”¨ US ç•¶é è¨­
        params.set("regionCode", regionCode || "US");
        if (categoryId) params.set("videoCategoryId", categoryId);
        if (pageToken) params.set("pageToken", pageToken);

        const url = `${YT_VIDEOS_BASE}?${params.toString()}`;
        const res = await fetch(url);
        const json = await res.json();
        if (!res.ok) {
          throw new Error(json.error?.message || "YouTube mostPopular API éŒ¯èª¤");
        }

        const items = json.items || [];
        items.forEach(item => {
          const snippet = item.snippet || {};
          const stats = item.statistics || {};
          const contentDetails = item.contentDetails || {};
          const publishedAt = snippet.publishedAt || "";
          // å…ˆç”¨æ—¥æœŸç²—ç¯©
          if (publishedAt && new Date(publishedAt) < afterDate) return;

          const durationSeconds = parseISODurationToSeconds(contentDetails.duration || "");
          const views = Number(stats.viewCount || 0);
          const thumbs = snippet.thumbnails || {};
          const thumbUrl =
            (thumbs.medium && thumbs.medium.url) ||
            (thumbs.high && thumbs.high.url) ||
            (thumbs.default && thumbs.default.url) ||
            "";
          const channelIdVal = snippet.channelId || "";
          const channelUrl = channelIdVal
            ? `https://www.youtube.com/channel/${channelIdVal}`
            : "";

          const v = {
            id: item.id,
            title: snippet.title || "(ç„¡æ¨™é¡Œ)",
            channel: snippet.channelTitle || "",
            channelId: channelIdVal,
            channelUrl,
            publishedAt,
            views,
            durationSeconds,
            thumbUrl,
            url: `https://www.youtube.com/watch?v=${item.id}`
          };

          // å†ç”¨ç‰‡é•· & è§€çœ‹æ•¸åš´æ ¼ç¯©
          if (v.durationSeconds != null &&
              v.durationSeconds <= maxSeconds &&
              (minViews <= 0 || v.views >= minViews)) {
            videos.push(v);
          }
        });

        pageToken = json.nextPageToken || null;
        pageCount += 1;
        if (!pageToken) break;
      }

      videos.sort((a, b) => b.views - a.views);
      return videos.slice(0, limit);
    }

    // æ¨¡å¼ Bï¼šæœ‰é—œéµå­—æˆ–é »é“ â†’ ä½¿ç”¨ search.list å†æ¥ videos.list
    async function searchBySearchAPI(options) {
      const {
        apiKey,
        regionCode,
        categoryId,
        days,
        maxSeconds,
        keyword,
        minViews,
        limit,
        maxPages,
        channelId
      } = options;

      const now = new Date();
      const afterDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
      const publishedAfter = afterDate.toISOString();

      let pageToken = null;
      const videoIds = [];
      let pageCount = 0;

      const useKeyword = !!keyword;
      const order = useKeyword ? "viewCount" : "date";

      while (pageCount < maxPages && videoIds.length < limit * 3) {
        const params = new URLSearchParams({
          key: apiKey,
          part: "id",
          type: "video",
          maxResults: "50",
          publishedAfter,
          order
        });

        if (regionCode) params.set("regionCode", regionCode);
        if (categoryId) params.set("videoCategoryId", categoryId);
        if (channelId) params.set("channelId", channelId);
        if (maxSeconds <= 240) params.set("videoDuration", "short");
        if (useKeyword) params.set("q", keyword);
        if (pageToken) params.set("pageToken", pageToken);

        const url = `${YT_SEARCH_BASE}?${params.toString()}`;
        const res = await fetch(url);
        const json = await res.json();

        if (!res.ok) {
          throw new Error(json.error?.message || "YouTube search API éŒ¯èª¤");
        }

        (json.items || []).forEach(item => {
          const id = item.id && item.id.videoId;
          if (id && !videoIds.includes(id)) videoIds.push(id);
        });

        pageToken = json.nextPageToken || null;
        pageCount += 1;
        if (!pageToken) break;
      }

      if (!videoIds.length) return [];

      const videoObjects = await fetchVideosDetail(apiKey, videoIds);

      let videos = videoObjects.map(item => {
        const snippet = item.snippet || {};
        const stats = item.statistics || {};
        const contentDetails = item.contentDetails || {};
        const durationSeconds = parseISODurationToSeconds(contentDetails.duration || "");
        const views = Number(stats.viewCount || 0);
        const thumbs = snippet.thumbnails || {};
        const thumbUrl =
          (thumbs.medium && thumbs.medium.url) ||
          (thumbs.high && thumbs.high.url) ||
          (thumbs.default && thumbs.default.url) ||
          "";
        const channelIdVal = snippet.channelId || "";
        const channelUrl = channelIdVal
          ? `https://www.youtube.com/channel/${channelIdVal}`
          : "";

        return {
          id: item.id,
          title: snippet.title || "(ç„¡æ¨™é¡Œ)",
          channel: snippet.channelTitle || "",
          channelId: channelIdVal,
          channelUrl,
          publishedAt: snippet.publishedAt || "",
          views,
          durationSeconds,
          thumbUrl,
          url: `https://www.youtube.com/watch?v=${item.id}`
        };
      });

      videos = videos.filter(v => {
        if (v.durationSeconds == null) return false;
        if (v.durationSeconds > maxSeconds) return false;
        if (minViews > 0 && v.views < minViews) return false;
        return true;
      });

      videos.sort((a, b) => b.views - a.views);
      return videos.slice(0, limit);
    }

    async function fetchVideosDetail(apiKey, ids) {
      const all = [];
      for (let i = 0; i < ids.length; i += 50) {
        const chunk = ids.slice(i, i + 50);
        const params = new URLSearchParams({
          key: apiKey,
          part: "snippet,statistics,contentDetails",
          id: chunk.join(",")
        });
        const url = `${YT_VIDEOS_BASE}?${params.toString()}`;
        const res = await fetch(url);
        const json = await res.json();
        if (!res.ok) {
          throw new Error(json.error?.message || "YouTube videos API éŒ¯èª¤");
        }
        all.push(...(json.items || []));
      }
      return all;
    }

    function parseISODurationToSeconds(iso) {
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return null;
      const h = parseInt(match[1] || "0", 10);
      const m = parseInt(match[2] || "0", 10);
      const s = parseInt(match[3] || "0", 10);
      return h * 3600 + m * 60 + s;
    }

    function formatDuration(sec) {
      if (sec == null || isNaN(sec)) return "æœªçŸ¥";
      if (sec < 60) return `${sec}s`;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}m${s}s`;
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString("zh-TW");
    }

    // å½±ç‰‡çµæœ
    function renderResults(videos) {
      resultsDiv.innerHTML = "";
      videos.forEach((v, idx) => {
        const row = document.createElement("div");
        row.className = "video-item";

        const thumbDiv = document.createElement("div");
        thumbDiv.className = "thumb";
        if (v.thumbUrl) {
          const img = document.createElement("img");
          img.src = v.thumbUrl;
          img.alt = v.title;
          thumbDiv.appendChild(img);
        }
        row.appendChild(thumbDiv);

        const main = document.createElement("div");
        main.className = "video-main";

        const titleDiv = document.createElement("div");
        titleDiv.className = "video-title";
        titleDiv.textContent = `${idx + 1}. ${v.title}`;
        main.appendChild(titleDiv);

        const metaDiv = document.createElement("div");
        metaDiv.className = "video-meta";
        metaDiv.textContent =
          `ğŸ‘ï¸ ${v.views.toLocaleString()} ï½œ â± ${formatDuration(v.durationSeconds)} ï½œ ` +
          `ğŸ“º ${v.channel || "æœªçŸ¥"} ï½œ ğŸ“… ${formatDateTime(v.publishedAt)}`;
        main.appendChild(metaDiv);

        if (v.channelUrl) {
          const chDiv = document.createElement("div");
          chDiv.className = "video-link";
          const ca = document.createElement("a");
          ca.href = v.channelUrl;
          ca.target = "_blank";
          ca.rel = "noopener noreferrer";
          ca.textContent = `é »é“é é¢ï¼š${v.channel || v.channelUrl}`;
          chDiv.appendChild(ca);
          main.appendChild(chDiv);
        }

        const linkDiv = document.createElement("div");
        linkDiv.className = "video-link";
        const a = document.createElement("a");
        a.href = v.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = v.url;
        linkDiv.appendChild(a);
        main.appendChild(linkDiv);

        row.appendChild(main);
        resultsDiv.appendChild(row);
      });
    }

    // å‰µä½œè€…æ¸…å–®
    function renderCreators(videos) {
      resultsDiv.innerHTML = "";

      const map = new Map();
      videos.forEach(v => {
        if (!v.channelId) return;
        let entry = map.get(v.channelId);
        if (!entry) {
          entry = {
            channelId: v.channelId,
            channel: v.channel || "æœªçŸ¥é »é“",
            channelUrl: v.channelUrl,
            videoCount: 0,
            totalViews: 0,
            maxViews: 0,
            sampleVideoUrl: v.url
          };
          map.set(v.channelId, entry);
        }
        entry.videoCount += 1;
        entry.totalViews += v.views;
        if (v.views > entry.maxViews) {
          entry.maxViews = v.views;
          entry.sampleVideoUrl = v.url;
        }
      });

      const creators = Array.from(map.values());
      creators.sort((a, b) => b.totalViews - a.totalViews);

      creators.forEach((c, idx) => {
        const row = document.createElement("div");
        row.className = "video-item";

        const thumbDiv = document.createElement("div");
        thumbDiv.className = "thumb";
        row.appendChild(thumbDiv);

        const main = document.createElement("div");
        main.className = "video-main";

        const titleDiv = document.createElement("div");
        titleDiv.className = "video-title";
        titleDiv.textContent = `${idx + 1}. ${c.channel}`;
        main.appendChild(titleDiv);

        const avg = Math.round(c.totalViews / c.videoCount);
        const metaDiv = document.createElement("div");
        metaDiv.className = "video-meta";
        metaDiv.textContent =
          `Shorts æ•¸é‡ï¼š${c.videoCount} ï½œ ç¸½è§€çœ‹ï¼š${c.totalViews.toLocaleString()} ï½œ ` +
          `å¹³å‡ï¼š${avg.toLocaleString()} / æ”¯ ï½œ æœ€é«˜å–®æ”¯ï¼š${c.maxViews.toLocaleString()}`;
        main.appendChild(metaDiv);

        if (c.channelUrl) {
          const chDiv = document.createElement("div");
          chDiv.className = "video-link";
          const ca = document.createElement("a");
          ca.href = c.channelUrl;
          ca.target = "_blank";
          ca.rel = "noopener noreferrer";
          ca.textContent = "é »é“é é¢";
          chDiv.appendChild(ca);
          main.appendChild(chDiv);
        }

        if (c.sampleVideoUrl) {
          const vDiv = document.createElement("div");
          vDiv.className = "video-link";
          const va = document.createElement("a");
          va.href = c.sampleVideoUrl;
          va.target = "_blank";
          va.rel = "noopener noreferrer";
          va.textContent = "è§€çœ‹è©²é »é“æœ€ç†±é–€å½±ç‰‡ä¹‹ä¸€";
          vDiv.appendChild(va);
          main.appendChild(vDiv);
        }

        row.appendChild(main);
        resultsDiv.appendChild(row);
      });
    }
  </script>
</body>
</html>
